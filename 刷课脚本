// ==UserScript==
// @name         2025å›½å®¶æ™ºæ…§æ•™è‚²å¹³å°å¯’å‡ç ”ä¿®ï¼Œå¯ç§’åˆ·è§†é¢‘ï¼é€‚åˆä¸­å°å­¦(åŸºç¡€æ•™è‚²ã€å¸ˆèŒƒç”Ÿå…è¯•è®¤å®š) | èŒä¸šæ•™è‚²  | é«˜ç­‰æ•™è‚²
// @namespace    http://tampermonkey.net/zzzzzzys_å›½å®¶ä¸­å°å­¦
// @version      1.0.4
// @description  é€‚ç”¨2025å›½å®¶æ™ºæ…§æ•™è‚²å¹³å°å¯’å‡ç ”ä¿®.ä¸­å°å­¦ã€å¸ˆèŒƒç”Ÿè¯¾ç¨‹ï¼Œå¯å¿«é€Ÿé€šè¿‡è§†é¢‘å­¦ä¹ ã€‚å³ç§’åˆ·ï¼| èŒä¸šæ•™è‚²/é«˜ç­‰æ•™è‚² å¯è‡ªåŠ¨æŒ‚æœºã€‚æ¬¢è¿åŠ å…¥QQäº¤æµç¾¤ï¼ŒåŠæ—¶è·å–æœ€æ–°æ¶ˆæ¯ï¼è¯·å‹¿éšæ„äºŒæ¬¡å‘å¸ƒä»£ç ï¼Œå°Šé‡åŸåˆ›ï¼
// @author       zzzzzzys
// @match        https://basic.smartedu.cn/*
// @match        https://core.teacher.vocational.smartedu.cn/*
// @match        https://test3.ykt.eduyun.cn/*
// @icon         https://basic.smartedu.cn/favicon.ico
// @require      https://fastly.jsdelivr.net/npm/crypto-js@4.2.0/crypto-js.min.js
// @resource     https://cdn.staticfile.org/limonte-sweetalert2/11.7.1/sweetalert2.min.css
// @require      https://fastly.jsdelivr.net/npm/sweetalert2@11.12.2/dist/sweetalert2.all.min.js
// @connect      basic.smartedu.cn
// @connect      x-study-record-api.ykt.eduyun.cn
// @grant        unsafeWindow
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_xmlhttpRequest
// @grant        GM_info
// @grant        GM_addStyle
// @run-at       document-end
// @license      GPL-3.0-or-later
// @downloadURL https://update.greasyfork.org/scripts/525037/2025%E5%9B%BD%E5%AE%B6%E6%99%BA%E6%85%A7%E6%95%99%E8%82%B2%E5%B9%B3%E5%8F%B0%E5%AF%92%E5%81%87%E7%A0%94%E4%BF%AE%EF%BC%8C%E5%8F%AF%E7%A7%92%E5%88%B7%E8%A7%86%E9%A2%91%EF%BC%81%E9%80%82%E5%90%88%E4%B8%AD%E5%B0%8F%E5%AD%A6%28%E5%9F%BA%E7%A1%80%E6%95%99%E8%82%B2%E3%80%81%E5%B8%88%E8%8C%83%E7%94%9F%E5%85%8D%E8%AF%95%E8%AE%A4%E5%AE%9A%29%20%7C%20%E8%81%8C%E4%B8%9A%E6%95%99%E8%82%B2%20%20%7C%20%E9%AB%98%E7%AD%89%E6%95%99%E8%82%B2.user.js
// @updateURL https://update.greasyfork.org/scripts/525037/2025%E5%9B%BD%E5%AE%B6%E6%99%BA%E6%85%A7%E6%95%99%E8%82%B2%E5%B9%B3%E5%8F%B0%E5%AF%92%E5%81%87%E7%A0%94%E4%BF%AE%EF%BC%8C%E5%8F%AF%E7%A7%92%E5%88%B7%E8%A7%86%E9%A2%91%EF%BC%81%E9%80%82%E5%90%88%E4%B8%AD%E5%B0%8F%E5%AD%A6%28%E5%9F%BA%E7%A1%80%E6%95%99%E8%82%B2%E3%80%81%E5%B8%88%E8%8C%83%E7%94%9F%E5%85%8D%E8%AF%95%E8%AE%A4%E5%AE%9A%29%20%7C%20%E8%81%8C%E4%B8%9A%E6%95%99%E8%82%B2%20%20%7C%20%E9%AB%98%E7%AD%89%E6%95%99%E8%82%B2.meta.js
// ==/UserScript==
/*****************************
 * ç›—ç‰ˆå¯è€»
 * è¯·å°Šé‡åŸåˆ›åŠ³åŠ¨æˆæœï¼
 * ä½œè€…ï¼šzzzzzzys
 * https://greasyfork.org/zh-CN/users/1176747-zzzzzzys
 * æ¬è¿å¯è€»
 ****************************/
(function () {
    'use strict';
    const qqGroup = [
        {customName:"ç¾¤1",id: "570337037", link: "https://qm.qq.com/q/rDCbvTiV9K", isFull: true,priority:0},
        {customName:"ç¾¤2",id: "618010974", link: "https://qm.qq.com/q/h854sxDvKa", isFull: true,priority:2},
        {customName:"ç¾¤3",id: "1003884618", link: "https://qm.qq.com/q/kRcyAunAic", isFull: true,priority:1},
        {customName:"ç¾¤4",id: "821240605", link: "https://qm.qq.com/q/z1ogtdhyGA", isFull: false,priority:2},
        {customName:"ç¾¤5",id: "1013973135", link: "https://qm.qq.com/q/EpXA5Ar3vG", isFull: false,priority:2},
    ]
    let qqUrl = "https://qm.qq.com/q/rDCbvTiV9K"
    let qqNum = "570337037"
    let qqNum2 = "618010974"
    let qqUrl2 = "https://qm.qq.com/q/h854sxDvKa"
    let biliUrl = "https://b23.tv/x5pFcB0"
    // ä¿å­˜åŸç”Ÿ XMLHttpRequest çš„å¼•ç”¨
    const originalXHR = unsafeWindow.XMLHttpRequest;
    let fullDatas=null
    // é‡å†™ XMLHttpRequest
    unsafeWindow.XMLHttpRequest = function() {
        const xhr = new originalXHR();
        const originalOpen = xhr.open;
        const originalSend = xhr.send;

        // é‡å†™ open æ–¹æ³•ï¼Œè®°å½•è¯·æ±‚ä¿¡æ¯
        xhr.open = function(method, url) {
            this._method = method;
            this._url = url;
            return originalOpen.apply(this, arguments);
        };

        // é‡å†™ send æ–¹æ³•ï¼Œç›‘å¬å“åº”
        xhr.send = function(body) {
            this.addEventListener('readystatechange', function() {
                if(this._url.includes("fulls.json")){
                    if (this.readyState === 4) { // è¯·æ±‚å®Œæˆ
                        console.log(body)
                        console.log('æ•è·åˆ° XHR è¯·æ±‚ç»“æœ:', {
                            url: this._url,
                            method: this._method,
                            status: this.status,
                            response: this.response
                        });
                        fullDatas=JSON.parse(this.response);
                    }
                }
            });
            return originalSend.apply(this, arguments);
        };

        return xhr;
    };

    // é¢„å¤„ç†ç¾¤ç»„æ•°æ®
    const renderQQGroups = () => {
        try {
            const activeGroups = qqGroup
                .filter(group => {
                    // æ·»åŠ æ•°æ®æ ¡éªŒ
                    if (!group.customName || !group.id) {
                        console.warn('Invalid group:', group);
                        return false;
                    }
                    return !group.isFull;
                })
                .sort((a, b) => a.priority - b.priority);

            // æ·»åŠ ç©ºçŠ¶æ€æç¤º
            if (activeGroups.length === 0) {
                return `<div style="color: #ff9999; text-align:center; margin:12px 0">
              æ‰€æœ‰ç¾¤ç»„å·²å¼€æ”¾ï¼Œæ¬¢è¿ç›´æ¥åŠ å…¥
            </div>`;
            }
            const title=`<div style="background: linear-gradient(135deg, #FF4DAF 0%, #FF6B6B 100%);display: flex; align-items: center; gap:15px;">
                            <img src="https://qzonestyle.gtimg.cn/qzone/qzact/act/external/tiqq/logo.png" 
                                 style="height:36px; border-radius:6px;">
                            <div>
                                <div style="font-size:16px; font-weight:bold; margin-bottom:4px;">æ•™å¸ˆäº¤æµç¾¤(è¯·ä¼˜å…ˆé€‰æ‹©æœªæ»¡ç¾¤åŠ å…¥)</div>
                                <div style="font-size:12px; opacity:0.9;">è·å–å®æ—¶æ”¯æŒ | æœ€æ–°åŠŸèƒ½ä¼˜å…ˆä½“éªŒ</div>
                            </div>
                        </div>`
            let content= title + activeGroups.map(group => `
                      <a href="${group.link}" 
                         target="_blank"
                         style="display: block; margin-top: 12px; padding: 10px;
                                background: rgba(255,255,255,0.2);
                                border-radius: 6px; text-align: center;
                                text-decoration: none; color: white !important;
                                transition: 0.3s; font-weight: 500;
                                cursor: pointer;"
                         aria-label="åŠ å…¥QQç¾¤${group.customName}ï¼ˆç¾¤å·ï¼š${group.id}ï¼‰">
                        ğŸ¯ ç‚¹å‡»åŠ å…¥${group.customName}:${group.id} <!-- ç§»é™¤ç¾¤å·æ˜¾ç¤º -->
                      </a>
                    `).join('');
            return `<div style="background: linear-gradient(135deg, #FF4DAF 0%, #FF6B6B 100%); padding:15px; border-radius:8px; color:white;">
                                    ${content}
                                </div>`
        } catch (error) {
            console.error('QQç¾¤æ¸²æŸ“é”™è¯¯:', error);
            return ''; // é™é»˜å¤±è´¥
        }
    };
    const groupHtml = `<!-- ç¤¾ç¾¤å…¥å£ -->
                    <div style="background: linear-gradient(135deg, #FF4DAF 0%, #FF6B6B 100%); padding:15px; border-radius:8px; color:white;">
                        <div style="display: flex; align-items: center; gap:15px;">
                            <img src="https://qzonestyle.gtimg.cn/qzone/qzact/act/external/tiqq/logo.png" 
                                 style="height:36px; border-radius:6px;">
                            <div>
                                <div style="font-size:16px; font-weight:bold; margin-bottom:4px;">æ•™å¸ˆäº¤æµç¾¤(è¯·ä¼˜å…ˆé€‰æ‹©æœªæ»¡ç¾¤åŠ å…¥)</div>
                                <div style="font-size:12px; opacity:0.9;">è·å–å®æ—¶æ”¯æŒ | æœ€æ–°åŠŸèƒ½ä¼˜å…ˆä½“éªŒ</div>
                            </div>
                        </div>
                        
                        <!-- QQç¾¤ -->
                        <a href="${qqGroup[2].isFull ? 'javascript:void(0);' : qqGroup[2].link}" 
                           ${qqGroup[2].isFull ? '' : 'target="_blank"'} 
                           style="display: block; margin-top:12px; padding:10px; 
                                  background: ${qqGroup[2].isFull ? '#999' : 'rgba(255,255,255,0.2)'}; 
                                  border-radius:6px; text-align:center; 
                                  text-decoration:none; color:white !important;
                                  transition:0.3s; font-weight:500;
                                  cursor: ${qqGroup[2].isFull ? 'not-allowed' : 'pointer'};">
                            ${qqGroup[2].isFull ? 'â›” ç¾¤å·²æ»¡' : 'ğŸ¯ ç‚¹å‡»åŠ å…¥QQç¾¤3ï¼š' + qqGroup[2].id}
                        </a>
                        <!-- QQç¾¤2 -->
                        <a href="${qqGroup[1].isFull ? 'javascript:void(0);' : qqGroup[1].link}" 
                           ${qqGroup[1].isFull ? '' : 'target="_blank"'} 
                           style="display: block; margin-top:12px; padding:10px; 
                                  background: ${qqGroup[1].isFull ? '#999' : 'rgba(255,255,255,0.2)'}; 
                                  border-radius:6px; text-align:center; 
                                  text-decoration:none; color:white !important;
                                  transition:0.3s; font-weight:500;
                                  cursor: ${qqGroup[1].isFull ? 'not-allowed' : 'pointer'};">
                            ${qqGroup[1].isFull ? 'â›” ç¾¤å·²æ»¡' : 'ğŸ¯ ç‚¹å‡»åŠ å…¥QQç¾¤2ï¼š' + qqGroup[1].id}
                        </a>
                        <!-- QQç¾¤ -->
                        <a href="${qqGroup[3].isFull ? 'javascript:void(0);' : qqGroup[3].link}" 
                           ${qqGroup[3].isFull ? '' : 'target="_blank"'} 
                           style="display: block; margin-top:12px; padding:10px; 
                                  background: ${qqGroup[3].isFull ? '#999' : 'rgba(255,255,255,0.2)'}; 
                                  border-radius:6px; text-align:center; 
                                  text-decoration:none; color:white !important;
                                  transition:0.3s; font-weight:500;
                                  cursor: ${qqGroup[3].isFull ? 'not-allowed' : 'pointer'};">
                            ${qqGroup[3].isFull ? 'â›” ç¾¤å·²æ»¡' : 'ğŸ¯ ç‚¹å‡»åŠ å…¥QQç¾¤4ï¼š' + qqGroup[3].id}
                        </a>
                        <!-- QQç¾¤ -->
                        <a href="${qqGroup[4].isFull ? 'javascript:void(0);' : qqGroup[4].link}" 
                           ${qqGroup[4].isFull ? '' : 'target="_blank"'} 
                           style="display: block; margin-top:12px; padding:10px; 
                                  background: ${qqGroup[4].isFull ? '#999' : 'rgba(255,255,255,0.2)'}; 
                                  border-radius:6px; text-align:center; 
                                  text-decoration:none; color:white !important;
                                  transition:0.3s; font-weight:500;
                                  cursor: ${qqGroup[4].isFull ? 'not-allowed' : 'pointer'};">
                            ${qqGroup[4].isFull ? 'â›” ç¾¤å·²æ»¡' : 'ğŸ¯ ç‚¹å‡»åŠ å…¥QQç¾¤5ï¼š' + qqGroup[4].id}
                        </a>

                        <!-- QQç¾¤ -->
                        <a href="${qqGroup[0].isFull ? 'javascript:void(0);' : qqGroup[0].link}" 
                           ${qqGroup[0].isFull ? '' : 'target="_blank"'} 
                           style="display: block; margin-top:12px; padding:10px; 
                                  background: ${qqGroup[0].isFull ? '#999' : 'rgba(255,255,255,0.2)'}; 
                                  border-radius:6px; text-align:center; 
                                  text-decoration:none; color:white !important;
                                  transition:0.3s; font-weight:500;
                                  cursor: ${qqGroup[0].isFull ? 'not-allowed' : 'pointer'};">
                            ${qqGroup[0].isFull ? 'â›” ç¾¤å·²æ»¡' : 'ğŸ¯ ç‚¹å‡»åŠ å…¥QQç¾¤ï¼š' + qqGroup[0].id}
                        </a>
                        <a href="${biliUrl}" 
                           target="_blank" 
                           style="display: block; margin-top:12px; padding:10px; 
                                  background: rgba(255,255,255,0.2); border-radius:6px; 
                                  text-align:center; text-decoration:none; color:white !important;
                                  transition:0.3s; font-weight:500;">
                            ğŸ“½ï¸ ç‚¹å‡»è§‚çœ‹ä½¿ç”¨æ•™ç¨‹ï¼Œå“”å“©å“”å“©ï¼š${biliUrl}
                        </a>
                    </div>`
    let requestObj = {
        fullsData: {
            url: "https://s-file-2.ykt.cbern.com.cn/teach/s_course/v2/activity_sets/3efdb592-138e-4854-8964-5e10f6011f33/fulls.json",
            method: "GET",
        },
        resourceLearningPositions: {
            url: "https://x-study-record-api.ykt.eduyun.cn/v1/resource_learning_positions/",
            method: "PUT"
        },
        /* èŒä¸šæ•™è‚² | é«˜ç­‰æ•™è‚²  */
        progress: {
            url: "https://core.teacher.vocational.smartedu.cn/p/course/services/member/study/progress",
            method: "POST",
        }
    }

    /********************************************************
     * èŒä¸šæ•™è‚²/é«˜ç­‰æ•™è‚²
     *******************************************************/
    const SWAL_CONFIG = {
        title: 'è¯¾ç¨‹è¿›åº¦æ§åˆ¶',
        html: `
            <div style="margin-bottom: 5px">
                <label>v${GM_info.script.version}</label>
            </div>
            <div style="
                padding: 12px;
                background: #e8f4ff;
                border-radius: 8px;
                margin-bottom: 15px;
                border: 1px solid #b3d4fc;
                text-align: center;
            ">
                <span style="
                    font-size: 14px;    
                    color: #ff4daf;
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                ">
                    <span style="font-size: 16px">ğŸ¯</span>
                    è€å¸ˆæ‚¨å¥½ï¼Œç‚¹å‡»å¼€å§‹æŒ‰é’®ï¼Œå¼€å§‹å‡è´Ÿä¹‹æ—…<br>
                    è„šæœ¬ä¼šè‡ªåŠ¨å­¦ä¹ å½“å‰é¡µæ‰€æœ‰è§†é¢‘ï¼Œæ‚¨å¯å®‰å¿ƒä¼‘æ¯ç‰‡åˆ»
                </span>
            </div>
             <div style="margin-bottom: 15px">
                <label>å½“å‰è§†é¢‘ï¼š</label>
                <div id="currentVideo" style="
                    font-size: 16px;
                    color: #3498db;
                    font-weight: 500;
                    margin: 8px 0;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                ">å°šæœªå¼€å§‹</div>
            </div>
            <div class="progress-container" style="
                background: #f0f0f0;
                height: 20px;
                border-radius: 10px;
                margin: 15px 0;
                overflow: hidden;
            ">
                <div id="swalProgressBar" style="
                    height: 100%;
                    background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
                    width: 0;
                    transition: width 0.3s ease;
                "></div>
            </div>
            <div style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                margin-bottom: 15px;
            ">
                <div>
                    <label>å½“å‰è¿›åº¦</label>
                    <div id="currentProgress" style="
                        font-size: 18px;
                        font-weight: bold;
                        color: #2c3e50;
                    ">0:00</div>
                </div>
                <div>
                    <label>å¤§æ¦‚éœ€è¦æ—¶é—´</label>
                    <div id="needTime" style="
                        font-size: 14px;
                        color: #2efd00;
                    ">è¿˜æœªå¼€å§‹</div>
                </div>
                <div>
                    <label>æ€»æ—¶é•¿</label>
                    <div id="totalTime" style="
                        font-size: 14px;
                        color: #7f8c8d;
                    ">è¿˜æœªå¼€å§‹</div>
                </div>
            </div>
            <div id="statusMessage" style="
                padding: 10px;
                border-radius: 5px;
                margin: 10px 0;
                background: #f8f9fa;
                text-align: center;
            ">å‡†å¤‡å°±ç»ª</div>
            <div style="
            padding: 12px;
            background: #f5f7fa;
            border-radius: 8px;
            margin: 12px 0;
            border: 1px solid #e4e7ed;
        ">
           ${renderQQGroups()}
        </div>
            <div id="author" style="
                padding: 8px 16px; /* é€‚å½“çš„ä¸Šä¸‹å·¦å³å†…è¾¹è· */
                border-radius: 10px;
                margin: 10px 0;
                background: #f8f9fa;
                text-align: center;
                font-size: 12px; /* ç¨å¾®å¢å¤§å­—ä½“ */
                font-weight: bold; /* åŠ ç²—å­—ä½“ */
                color: #495057; /* æ›´æ·±çš„å­—ä½“é¢œè‰²ï¼Œå¢å¼ºå¯è¯»æ€§ */
                border: 1px solid #dee2e6; /* æ·»åŠ è¾¹æ¡† */
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* è½»å¾®é˜´å½±æ•ˆæœ */
                letter-spacing: 1px; /* å¢åŠ å­—æ¯é—´è· */
            ">
                By YoungthZou. ç›—ç å¯è€»ï¼ zzzzzzys
            </div>
        `,
        showConfirmButton: false,
        allowOutsideClick: false,
        allowEscapeKey: false,
        width: 600,
        willOpen: () => {
            document.querySelector('.swal2-close').remove();
        }
    };

    // çŠ¶æ€ç®¡ç†
    let currentProgress = 60;
    let isRunning = false;
    let timerId = null;
    let swalInstance = null;
    let totalTime = 1000;
    let checkInterval = null
    // å·¥å…·å‡½æ•°
    const formatTime = (seconds) => {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    };

    const updateUI = (progress, status) => {
        if (!swalInstance) return;

        // æ›´æ–°è¿›åº¦æ¡
        const progressBar = swalInstance.querySelector('#swalProgressBar');
        const percent = (progress / totalTime * 100).toFixed(1);
        progressBar.style.width = `${Math.min(parseFloat(percent), 100)}%`;

        // æ›´æ–°æ–‡æœ¬æ˜¾ç¤º
        swalInstance.querySelector('#currentProgress').textContent = formatTime(progress);
        swalInstance.querySelector('#totalTime').textContent = formatTime(totalTime);
        swalInstance.querySelector('#needTime').textContent = formatTime(parseInt(((totalTime - progress) / 3).toFixed(0)));

        // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
        const statusEl = swalInstance.querySelector('#statusMessage');
        statusEl.textContent = {
            loading: 'ğŸ”„ æ­£åœ¨åŒæ­¥è¿›åº¦...',
            success: 'âœ… åŒæ­¥æˆåŠŸ,stand by...',
            error: 'âŒ åŒæ­¥å¤±è´¥(é•¿æ—¶é—´å¤±è´¥ï¼Œè¯·åé¦ˆ)',
            idle: 'â¸ å·²æš‚åœ',
            finished: 'âœ…å·²å­¦å®Œï¼Œè·³è¿‡...',
            finishAll: 'å·²å…¨éƒ¨å­¦å®Œ,è¯·æ‰‹åŠ¨åˆ·æ–°ï¼Œç»™ä¸ªå¥½è¯„å§~',
            next: "ğŸ”„ æ­¤è§†é¢‘å·²å­¦å®Œï¼Œå‡†å¤‡å­¦ä¹ ä¸‹ä¸€ä¸ª..."
        }[status] || 'å‡†å¤‡å°±ç»ª';

        statusEl.style.color = {
            loading: '#f39c12',
            success: '#2ecc71',
            error: '#e74c3c',
            idle: '#7f8c8d',
            finished: '#0022fd',
            finishAll: '#ff4daf',
            next: '#f39c12',
        }[status];
    };

    // å‘é€è¯·æ±‚
    const sendProgress = async (videoId) => {
        updateUI(currentProgress, 'loading');
        let oriData = {
            courseId: unsafeWindow.courseId,
            itemId: unsafeWindow.p.itemId,
            videoId: videoId,
            playProgress: currentProgress,
            segId: unsafeWindow.p.segId,
            type: unsafeWindow.p.type,
            tjzj: 1,
            clockInDot: currentProgress,//åå°è¦æ±‚æ­¤å‚æ•°ä¸ºè§†é¢‘æ’­æ”¾çš„ä½ç½®
            sourceId: unsafeWindow.p.projectId,
            timeLimit: unsafeWindow.timilistParam.timeLimit || -1,
            originP: unsafeWindow.p.originP === 1 ? 2 : 1,  // ç¡¬ç¼–ç ï¼Œç­‰å¾…ä¿®æ”¹
        }
        try {
            const response = await fetch(
                `${requestObj.progress.url}?orgId=${unsafeWindow.p.orgId}`,
                {
                    method: "POST",
                    headers: {
                        "content-type": "application/x-www-form-urlencoded; charset=UTF-8",
                        "x-requested-with": "XMLHttpRequest",
                        "u-platformId": unsafeWindow.platformInfo.id
                    },
                    credentials: "include",
                    body: new URLSearchParams(oriData)
                }
            );

            const data = await response.json();
            console.log(data)
            if (data.data?.videoProgress > 0) {
                currentProgress = parseInt(data.data.videoProgress);
                updateUI(currentProgress, 'success');
                return data.data.progress;
            } else {
                throw new Error('æ— æ•ˆçš„æœåŠ¡å™¨å“åº”');
            }
        } catch (error) {
            console.error('è¯·æ±‚å¤±è´¥:', error);
            updateUI(currentProgress, 'error');
        }
    };

    // åˆ›å»ºæ§åˆ¶ç•Œé¢
    function createControlPanel() {
        Swal.fire({
            ...SWAL_CONFIG,
            didOpen: (modal) => {
                swalInstance = modal;

                // æ·»åŠ æ§åˆ¶æŒ‰é’®
                const actions = document.createElement('div');
                actions.style = `
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 10px;
                    margin-top: 15px;
                `;

                const startBtn = createButton('â–¶ å¼€å§‹', '#2ecc71', async () => {
                    if (!isRunning) {
                        try {
                            try {
                                document.querySelector('video').pause()
                            }catch (e) {

                            }
                            isRunning = true;
                            startBtn.textContent = 'â¸ æš‚åœ';
                            startBtn.style.background = '#e74c3c';
                            let courseData = getCourseData();
                            for (const courseDatum of courseData) {
                                if (!isRunning) {
                                    return
                                }
                                await sleep(2000)
                                console.log(courseDatum.name)
                                swalInstance.querySelector('#currentVideo').textContent = courseDatum.name
                                currentProgress = 0;
                                totalTime = parseInt(courseDatum.duration);
                                if (parseInt(courseDatum.progress) === 1) {
                                    console.log(" å·²å­¦å®Œï¼Œè·³è¿‡...")
                                    updateUI(currentProgress, 'finished');
                                    continue;
                                }
                                do {
                                    const progress = await sendProgress(courseDatum.videoId, currentProgress); // ç«‹å³æ‰§è¡Œ
                                    if (progress === "1.0") {
                                        // currentProgress=0;
                                        break;
                                    }

                                    // currentProgress += 60
                                    // å¯ä¸­æ–­çš„ç­‰å¾…
                                    await interruptibleWait(21000);
                                } while (currentProgress < totalTime && isRunning)
                                updateUI(currentProgress, 'next');
                                await sleep(20000);
                            }
                            // éæš‚åœç»“æŸ
                            if(isRunning){
                                currentProgress = 1;
                                totalTime = 1;
                                updateUI(currentProgress, 'finishAll');
                                startBtn.textContent = 'â–¶ å¼€å§‹';
                                startBtn.style.background = '#2ecc71';
                            }
                        } catch (e) {
                            console.error(e)
                            if (Swal) {
                                Swal.fire({
                                    title: "å¤±è´¥ï¼",
                                    text: e.toString() + "è¯·åœ¨è§†é¢‘æ’­æ”¾é¡µé¢ä½¿ç”¨ï¼ï¼ï¼",
                                    icon: 'error',
                                    // showCancelButton: true,
                                    confirmButtonColor: "#FF4DAFFF",
                                    // cancelButtonText: "å–æ¶ˆï¼Œç­‰ä¼šåˆ·æ–°",
                                    confirmButtonText: "ç‚¹å‡»å»åé¦ˆ",

                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.open("https://greasyfork.org/zh-CN/scripts/525037/feedback")
                                    }
                                });
                            }
                        }finally {
                            isRunning = false;
                        }

                    } else {
                        isRunning = false;
                        startBtn.textContent = 'â–¶ ç»§ç»­';
                        startBtn.style.background = '#2ecc71';
                        // clearInterval(timerId);
                        if (checkInterval) {
                            clearTimeout(checkInterval.timer);
                            checkInterval.resolve(); // ç«‹å³ç»“æŸç­‰å¾…
                        }
                        updateUI(currentProgress, 'idle');
                        setTimeout(() => {
                            updateUI(currentProgress, 'idle');
                        }, 2000)
                    }
                });

                const resetBtn = createButton('â†’å»å¥½è¯„', '#dbba34', () => {
                    window.open("https://greasyfork.org/zh-CN/scripts/525037/feedback")
                });

                actions.append(startBtn, resetBtn);
                modal.querySelector('.swal2-html-container').append(actions);
            }
        });
    }

    /**
     * ç¡çœ 
     * @param time
     * @returns {Promise<unknown>}
     */
    const sleep = function (time) {
        return new Promise(resolve => setTimeout(resolve, time));
    }

    function interruptibleWait(ms) {
        return new Promise(resolve => {
            const timer = setTimeout(resolve, ms);
            // æš´éœ²æ¸…é™¤æ–¹æ³•ä»¥ä¾¿ç«‹å³æš‚åœ
            checkInterval = {timer, resolve};
        });
    }

    function createButton(text, color, onClick) {
        const btn = document.createElement('button');
        btn.textContent = text;
        btn.style = `
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background: ${color};
            color: white;
            cursor: pointer;
            transition: opacity 0.3s;
        `;
        btn.addEventListener('click', onClick);
        btn.addEventListener('mouseenter', () => btn.style.opacity = 0.8);
        btn.addEventListener('mouseleave', () => btn.style.opacity = 1);
        return btn;
    }

    function getCourseData() {
        let courseData = unsafeWindow.initlessons
        console.log(courseData)
        if (!courseData) {
            updateUI(currentProgress, 'error');
            console.error("no course data!");
            return
        }
        courseData = courseData.filter(item => {
            return item?.type !== "1";
        });
        return [...courseData];
    }


    /********************************************************
     * æ‰“èµ
     *******************************************************/
    GM_addStyle(`
.donate-panel {
    position: fixed;
    left: 30%;
    top:50%;
    background: linear-gradient(135deg, #fff5f5 0%, #fff0f7 100%);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(255, 77, 175, 0.2);
    padding: 24px;
    width: 520px;
    
    z-index: 2147483647;
    transform: translateY(-100); /* åˆå§‹éšè—ä½ç½® */
    opacity: 1; /* ç¡®ä¿åˆå§‹å¯è§æ€§ */
    border: 1px solid #ffe6f0;
    backdrop-filter: blur(8px);
    transition: none; /* ç¦ç”¨transitionæ”¹ç”¨animation */
}

.donate-header {
    position: relative;
    font-size: 18px;
    color: #ff4daf;
    margin-bottom: 20px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
    padding-bottom: 12px;
    border-bottom: 2px solid rgba(255, 77, 175, 0.1);
}

.donate-header::after {
    content: "âœ¨";
    position: absolute;
    right: 0;
    top: -8px;
    font-size: 24px;
    animation: sparkle 2s infinite;
}

.motivation-text {
    font-size: 13px;
    color: #666;
    line-height: 1.6;
    margin: 12px 0;
    background: rgba(255, 255, 255, 0.9);
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #ffebf3;
}

@keyframes heartbeat {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

@keyframes sparkle {
    0% { opacity: 0.3; }
    50% { opacity: 1; }
    100% { opacity: 0.3; }
}
@keyframes panelSlideIn {
    from { transform: translateY(100%); opacity: 0; }
    to { transform: translateY(-50%); opacity: 1; }
}

@keyframes panelSlideOut {
    from { transform: translateY(0); opacity: 1; }
    to { transform: translateY(100%); opacity: 0; }
}

@keyframes heartbeat {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

.qr-grid {
    display: grid;
    grid-template-columns: 1fr; /* æ”¹ä¸ºå•åˆ—å¸ƒå±€ */
    gap: 24px;
    margin: 24px auto;
    max-width: 300px; /* å¢å¤§å®¹å™¨å®½åº¦ */
}

.qr-item {
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    transition: 0.3s;
    padding: 12px; /* å¢åŠ å†…è¾¹è· */
    background: #fff;
    box-shadow: 0 4px 12px rgba(255, 77, 175, 0.1);
}

.qr-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 16px rgba(255, 77, 175, 0.2);
}

.qr-item img {
    width: 100%;
    height: auto; /* ä¿æŒæ¯”ä¾‹ */
    border-radius: 8px;
    border: 1px solid #ffe5f0;
    min-height: 280px; /* æœ€å°é«˜åº¦ä¿è¯ */
}

.qr-item p {
    text-align: center;
    margin: 16px 0 8px;
    font-size: 16px; /* å¢å¤§æ–‡å­— */
    color: #ff4daf;
    font-weight: 600;
}
/* æ–°å¢æ–‡å­—æ ·å¼ */
.qr-tips {
    text-align: center;
    margin: 8px 0;
    font-size: 14px;
    color: #ff7ab8; /* æ›´æŸ”å’Œçš„ç²‰è‰² */
}

.qr-proverb {
    font-style: italic;
    color: #ff9ec7; /* æ›´æµ…çš„ç²‰è‰² */
    font-size: 13px;
    margin-top: 4px;
}

/* ä¿®æ”¹åŸæœ‰.qr-item pæ ·å¼ */
.qr-item p {
    margin: 12px 0 4px; /* å‡å°ä¸‹è¾¹è· */
    /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜ */
}

/* æ‰‹æœºæ¨ªå±/å¹³æ¿é€‚é… */
@media (min-width: 600px) {
    .qr-grid {
        grid-template-columns: 1fr 1fr; /* å¤§å±å¹•æ¢å¤åŒåˆ— */
        max-width: 600px;
    }
    .qr-item img {
        min-height: 240px;
    }
}

.third-party {
    margin-top: 20px;
}

.platform-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 12px;
    background: linear-gradient(135deg, #fff0f5 0%, #fff8fb 100%);
    border-radius: 8px;
    text-decoration: none;
    color: #ff6699 !important;
    font-size: 14px;
    margin: 8px 0;
    transition: 0.3s;
    border: 1px solid #ffe6ee;
}
.donate-panel.active {
    animation: panelSlideIn 0.4s cubic-bezier(0.22, 0.61, 0.36, 1) forwards;
}

.donate-panel.exit {
    animation: panelSlideOut 0.3s ease forwards;
}

/* è§¦å‘æŒ‰é’®åŠ¨ç”» */
#donate-trigger {
    animation: heartbeat 1.8s ease-in-out infinite;
}
.platform-btn:hover {
    background: linear-gradient(135deg, #ffe6ee 0%, #fff1f7 100%);
    box-shadow: 0 4px 12px rgba(255, 77, 175, 0.1);
}

.close-btn {
    /* ä¿æŒåŸæœ‰æ ·å¼ */
}
`);

    // æ¿€åŠ±æ–‡æ¡ˆåº“
    const motivationTexts = [
        "æ‚¨çš„æ¯ä¸€ä»½æ”¯æŒéƒ½å°†è½¬åŒ–ä¸ºï¼š",
        "â¤ï¸ æœåŠ¡å™¨ç»­è´¹ ",
        "ğŸ› ï¸ æŒç»­å¼€å‘ç»´æŠ¤ ",
        "â˜• æ·±å¤œç å†œçš„å’–å•¡ç‡ƒæ–™",
        "ğŸˆ å°çŒ«æœ€çˆ±çš„æ°´ç…®é¸¡èƒ¸è‚‰",
    ];

    // åŠ¨æ€ç”Ÿæˆæ¿€åŠ±æ–‡æ¡ˆ
    function generateMotivation() {
        const fragments = [
            '<div class="motivation-text">',
            'ğŸŒŸ <strong>æ„Ÿè°¢ä½¿ç”¨æœ¬è„šæœ¬ï¼</strong>',
            ...motivationTexts.map(t => `â€¢ ${t}`),
            '</div>'
        ].join('<br>');

        return fragments
            .replace('${donateCount}', '1,234')
            .replace('${updateDays}', '365');
    }
    // æ‰“èµé¢æ¿HTMLç»“æ„
    const donateHTML = `
<div  id="donate-panel">
    ${generateMotivation()}
    <div class="donate-header">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="#1e62ec">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
        æ”¯æŒå¼€å‘è€…
    </div>
    <div class="qr-grid">
        <div class="qr-item">
            <p>å¾®ä¿¡æ‰«ç æ”¯æŒ</p>
            <img style="width: 200px;height: 266px" src="https://mp-8ba0e2a3-d9c9-45a0-a902-d3bde09f5afd.cdn.bspapp.com/monkey-pic/WeChat.jpg" alt="å¾®ä¿¡èµèµç ">
            <div class="qr-tips">
            <p>â¤ï¸æŒç»­åˆ›ä½œéœ€è¦æ‚¨çš„æ”¯æŒ</p>
            <p class="qr-proverb">æ˜Ÿç«ç›¸èšï¼Œç»ˆæˆå…‰èŠ’</p>
             </div>
            
        </div>
        <div class="qr-item">
            <p>æ”¯ä»˜å®æ‰«ç æ”¯æŒ</p>
            <img style="width: 200px;height: 266px" src="https://mp-8ba0e2a3-d9c9-45a0-a902-d3bde09f5afd.cdn.bspapp.com/monkey-pic/alipay.jpg" alt="æ”¯ä»˜å®æ”¶æ¬¾ç ">
            <div class="qr-tips">
            <p>ğŸŒ¸æ¯ä¸€ä»½å¿ƒæ„éƒ½å€¼å¾—çæƒœ</p>
            <p class="qr-proverb">ä¸å•»å¾®èŠ’ï¼Œé€ çŸ©æˆé˜³</p>
        </div>
            
        </div>
    </div>
    <div class="donate-header">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="#1e62ec">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
        </svg>
        æ„Ÿè°¢æ‚¨çš„æ”¯æŒï¼
    </div>
    <div class="third-party">
        <!--<a href="https://afdian.net/@yourid" class="platform-btn" target="_blank">
            <svg viewBox="0 0 1024 1024" width="14" height="14" style="vertical-align:-2px;">
                <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372zm218-572.1h-50.4c-4.4 0-8 3.6-8 8v384.2c0 4.4 3.6 8 8 8h145.7c4.4 0 8-3.6 8-8V319.9c0-4.4-3.6-8-8-8h-50.4c-4.4 0-8 3.6-8 8v151.7H730V319.9c0-4.4-3.6-8-8-8zM328.1 703.9c-4.4 0-8-3.6-8-8v-384c0-4.4 3.6-8 8-8h50.4c4.4 0 8 3.6 8 8v151.7h116.7V319.9c0-4.4 3.6-8 8-8h50.4c4.4 0 8 3.6 8 8v384.2c0 4.4-3.6 8-8 8h-145c-4.4 0-8-3.6-8-8v-151H344v151c0 4.4-3.6 8-8 8H328.1z"/>
            </svg>
            çˆ±å‘ç”µæ”¯æŒ
        </a>-->

        <div class="platform-btn" id="donate-panel-close">æ„Ÿè°¢å¼€å‘è€…ï¼Œå·²æ”¯æŒ~</div>
    </div>
</div>
`;

    // åˆå§‹åŒ–æ‰“èµé¢æ¿
    function initDonate() {
        if (document.getElementById('donate-panel')) return;

        const panel = document.createElement('div');
        panel.innerHTML = donateHTML;
        panel.className = 'donate-panel';
        document.body.appendChild(panel);

        // å¼ºåˆ¶é‡æ’è§¦å‘åŠ¨ç”»
        void panel.offsetWidth; // è§¦å‘CSSé‡ç»˜
        panel.classList.add('active');

        // å…³é—­æŒ‰é’®äº‹ä»¶
        panel.querySelector('#donate-panel-close').addEventListener('click', () => {
            panel.classList.remove('active');
            panel.classList.add('exit');
            panel.addEventListener('animationend', () => {
                panel.remove();
            }, {once: true});
        });

        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        const clickHandler = (e) => {
            if (!panel.contains(e.target) && e.target.id !== 'donate-trigger') {
                panel.classList.add('exit');
                panel.addEventListener('animationend', () => {
                    panel.remove();
                }, {once: true});
                document.removeEventListener('click', clickHandler);
            }
        };
        setTimeout(() => document.addEventListener('click', clickHandler), 100);
    }

    // æ˜¾ç¤ºè§¦å‘æŒ‰é’®
    const trigger = document.createElement('div');
    trigger.innerHTML = 'â¤ï¸ æ‰“èµæ”¯æŒ';
    Object.assign(trigger.style, {
        position: 'fixed',
        left: '10px',
        top: '415px',
        background: '#ff6b6b',
        color: 'white',
        padding: '8px 16px',
        borderRadius: '20px',
        cursor: 'pointer',
        zIndex: '999999999999999',
        boxShadow: '0 2px 8px rgba(0,0,0,0.2)',
        fontSize: '14px'
    });
    // è§¦å‘æŒ‰é’®å¢å¼º
    Object.assign(trigger.style, {
        background: 'linear-gradient(135deg, #ff4daf 0%, #ff6b6b 100%)',
        fontWeight: '600',
        padding: '12px 24px',
        boxShadow: '0 4px 24px rgba(255, 77, 175, 0.3)',
        animation: 'heartbeat 1.5s ease-in-out infinite',
        border: '1px solid #ffb3d9'
    });
    trigger.addEventListener('click', initDonate);
    document.body.appendChild(trigger);

    /********************************************************
     * ä¸­å°å­¦æ™ºæ…§æ•™è‚²å¹³å° * å¯’å‡ç ”ä¿®
     *******************************************************/
        //æ ·å¼
    let style = `.button-3 {
              position: fixed;  
              appearance: none;
              background-color: #ed5822;
              border: 1px solid rgba(27, 31, 35, .15);
              border-radius: 6px;
              box-shadow: rgba(27, 31, 35, .1) 0 1px 0;
              box-sizing: border-box;
              color: #ffffff;
              cursor: pointer;
              display: inline-block;
              font-family: -apple-system,system-ui,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
              font-size: 14px;
              font-weight: 600;
              line-height: 20px;
              padding: 6px 16px;
              left: 20px;
              top: 300px;
              text-align: center;
              text-decoration: none;
              user-select: none;
              -webkit-user-select: none;
              touch-action: manipulation;
              vertical-align: middle;
              white-space: nowrap;
              z-index: 2147483647;
            }
  
            .button-3:focus:not(:focus-visible):not(.focus-visible) {
              box-shadow: none;
              outline: none;
            }
  
            .button-3:hover {
              background-color: #2c974b;
            }
  
            .button-3:focus {
              box-shadow: rgba(46, 164, 79, .4) 0 0 0 3px;
              outline: none;
            }
  
            .button-3:disabled {
              background-color: #94d3a2;
              border-color: rgba(27, 31, 35, .1);
              color: rgba(255, 255, 255, .8);
              cursor: default;
            }
  
            .button-3:active {
              background-color: #298e46;
              box-shadow: rgba(20, 70, 32, .2) 0 1px 0 inset;
            }`
    const showQQGroup = () => {

    }
    const createFloatingButton = () => {
        // å¦‚æœæŒ‰é’®å·²å­˜åœ¨åˆ™å…ˆç§»é™¤æ—§å®ä¾‹
        const existingBtn = document.getElementById('zs-helper-btn');
        if (existingBtn) existingBtn.remove();

        // ç›´æ¥åˆ›å»ºæŒ‰é’®å…ƒç´ ï¼ˆå»æ‰å¤–å±‚divåµŒå¥—ï¼‰
        const btn = document.createElement('div');
        btn.id = 'zs-helper-btn'; // ç¡®ä¿å”¯ä¸€IDç›´æ¥è®¾ç½®åœ¨å…ƒç´ ä¸Š
        btn.style.cssText = `
        position: fixed;
        left: 10px;
        top: 250px;
        transform: translateY(-50%);
        background: #ed5822;
        color: white;
        padding: 12px 24px;
        border-radius: 30px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(255,77,175,0.3);
        z-index: 2147483647; /* ä½¿ç”¨æœ€å¤§z-indexå€¼ */
        transition: 0.3s;
        font-family: 'Microsoft Yahei', sans-serif;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
    `;

        // æ·»åŠ å†…éƒ¨HTMLå†…å®¹
        btn.innerHTML = `
        <svg style="width:18px;height:18px;fill:white;" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
        </svg>
        <span>ä½¿ç”¨æŒ‡å—</span>
    `;

        // ä½¿ç”¨æ›´å¯é çš„äº‹ä»¶ç›‘å¬æ–¹å¼
        const handleHover = () => {
            btn.style.transform = 'translateY(-50%) scale(1.05)';
            btn.style.boxShadow = '0 6px 16px rgba(255,77,175,0.4)';
        };

        const handleLeave = () => {
            btn.style.transform = 'translateY(-50%) scale(1)';
            btn.style.boxShadow = '0 4px 12px rgba(255,77,175,0.3)';
        };

        btn.addEventListener('mouseenter', handleHover);
        btn.addEventListener('mouseleave', handleLeave);
        btn.addEventListener('click', showGuideDialog);

        document.body.appendChild(btn);
        return btn;
    };
    // æ˜¾ç¤ºæ“ä½œæŒ‡å—å¼¹çª—
    const showGuideDialog = () => {
        if (Swal) {
            Swal.fire({
                title: `<span style="color: #FF4DAF; font-size:26px; display: flex; align-items: center; gap:8px;">ğŸ“š æ™ºèƒ½åˆ·è¯¾æŒ‡å— <div style="font-size:12px; color:#95a5a6; margin-left:auto;">v${GM_info.script.version}</div></span>`,
                html: `
                <div style="text-align: left; max-width: 720px; line-height: 1.8;">
                    <!-- æ“ä½œæ­¥éª¤ -->
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="color: red; font-weight:500; margin-bottom:10px;">
                            æ’­æ”¾é¡µé¢æœªæ­£å¸¸ç”Ÿæ•ˆè¯·åˆ·æ–°é¡µé¢ï¼æ’­æ”¾é¡µé¢å·¦ä¾§æ— çº¢è‰²æŒ‰é’®è¯·åˆ·æ–°é¡µé¢ï¼
                        </div>
                        <div style="color: #2c3e50; font-weight:500; margin-bottom:10px;">
                            ğŸš€ æé€Ÿæ“ä½œæµç¨‹<br>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 32px 1fr; gap: 10px; align-items: center;">
                            <div style="background: #FF4DAF; color: white; width:24px; height:24px; border-radius:50%; text-align:center; line-height:24px;">1</div>
                            <div>è¿›å…¥2025ç ”ä¿®è¯¾ç¨‹æ’­æ”¾é¡µé¢</div>
                            
                            <div style="background: #FF4DAF; color: white; width:24px; height:24px; border-radius:50%; text-align:center; line-height:24px;">2</div>
                            <div>ç­‰å¾…è§†é¢‘åŠ è½½å®Œæˆï¼ˆ<span style="color:#e74c3c">æœªè‡ªåŠ¨æ’­æ”¾æ—¶</span>ï¼‰</div>
                            
                            <div style="background: #FF4DAF; color: white; width:24px; height:24px; border-radius:50%; text-align:center; line-height:24px;">3</div>
                            <div>ç‚¹å‡»å·¦ä¾§<span style="color:#FF4DAF; font-weight:bold">ã€Œå³åˆ»å¼€åˆ·ã€</span>æŒ‰é’®</div>
                        </div>
                    </div>

                    <!-- æ³¨æ„äº‹é¡¹ -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom:20px;">
                        <div style="border-left: 3px solid #FF4DAF; padding-left:12px;">
                            <div style="color: #e74c3c; font-weight:500; margin-bottom:8px;">âš ï¸ é‡è¦æé†’</div>
                            <ul style="margin:0; padding-left:18px; color:#7f8c8d; font-size:14px;">
                                <li>è§†é¢‘æœ€åå‰©ä¸‹5ç§’éœ€è¦çœ‹å®Œ</li>
                                <li>è¯·å‹¿ä¸»åŠ¨ç‚¹å‡»æ’­æ”¾</li>
                                <li>å»ºè®®åˆ·å®Œå…¨éƒ¨è§†é¢‘å†åˆ·æ–°ï¼Œè§‚çœ‹æœ€åçš„å‡ ç§’</li>
                            </ul>
                        </div>

                        <div style="border-left: 3px solid #27ae60; padding-left:12px;">
                            <div style="color: #27ae60; font-weight:500; margin-bottom:8px;">ğŸ’¡ é«˜æ•ˆæŠ€å·§</div>
                            <ul style="margin:0; padding-left:18px; color:#7f8c8d; font-size:14px;">
                                <li>å…ˆåˆ·ä¸€ä¸ªè§†é¢‘</li>
                                <li>ç‚¹å‡»å¦å¤–ä¸€ä¸ªè§†é¢‘</li>
                                <li>å†ç‚¹å‡»å›åˆšåˆ·çš„è§†é¢‘ï¼Œæ’­æ”¾å®Œæœ€å5s</li>
                            </ul>
                        </div>
                    </div>
                    ${renderQQGroups()}
                    
                </div>
            `,
                confirmButtonText: "å·²äº†è§£ï¼Œå¼€å§‹å‡è´Ÿä¹‹æ—… â†’",
                confirmButtonColor: "#FF4DAF",
                showCancelButton: true,
                cancelButtonText: "ä¸åœ¨æ˜¾ç¤ºæ­¤çª—å£",
                cancelButtonColor: "#95a5a6",
                width: 760,
                customClass: {
                    popup: 'animated pulse',
                    title: 'swal-title-custom'
                },
                footer: '<div style="color:#bdc3c7; font-size:12px;">è¯·åˆç†ä½¿ç”¨æœ¬å·¥å…·</div>'
            }).then((result) => {
                // console.log(result);
                // console.log(Swal.DismissReason.cancel);
                if (result.dismiss === Swal.DismissReason.cancel) {
                    // è·³è½¬åˆ°è¯¾ç¨‹åˆ—è¡¨é¡µæˆ–å…¶ä»–æ“ä½œ
                    localStorage.setItem('noMoreDialog', "ture")
                }
            });
        }
    }
    // åˆå§‹åŒ–é€»è¾‘
    // åˆå§‹åŒ–é€»è¾‘ä¼˜åŒ–
    const init = () => {
        // åˆ›å»ºæ‚¬æµ®æŒ‰é’®
        const floatBtn = createFloatingButton();

        // æ·»åŠ é˜²DOMæ¸…ç†ç›‘å¬ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        const observer = new MutationObserver(mutations => {
            if (!document.body.contains(floatBtn)) {
                createFloatingButton();
            }
        });
        observer.observe(document.body, {childList: true});

        // æ·»åŠ CSSä¿æŠ¤
        const style = document.createElement('style');
        style.textContent = `
        #zs-helper-btn {
            pointer-events: auto !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        #zs-helper-btn:hover {
            transform: translateY(-50%) scale(1.05) !important;
        }
    `;
        document.head.appendChild(style);
    };

    function getVideoTime() {
        return Math.round(document.querySelector('video').duration)
    }

    function getResourceId() {
        // è·å–ç›®æ ‡å…ƒç´ 
        const divElement = document.querySelector('div.vjs-poster');
        if (divElement) {

            const bgImage = divElement.style.backgroundImage;

            const uuidPattern = /assets\/([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/;
            const match = bgImage.match(uuidPattern);
            if (match) {
                const resId = match[1];
                console.log(resId);
                return resId
            }
        }
        throw Error("can not get ResourceId!")
    }

    function getResourceIdFromFullData() {
        if(!fullDatas || fullDatas.nodes?.length === 0) {
            throw Error("can't get fullDatas!")
        }
        const result = [];
        // é€’å½’éå†èŠ‚ç‚¹
        const traverse = (node) => {
            if (node.node_type === 'catalog' && node.child_nodes?.length > 0) {
                // å¦‚æœæ˜¯ç›®å½•èŠ‚ç‚¹ï¼Œç»§ç»­éå†å­èŠ‚ç‚¹
                node.child_nodes.forEach(child => traverse(child));
            } else if (node.node_type === 'activity') {
                // å¦‚æœæ˜¯æ´»åŠ¨èŠ‚ç‚¹ï¼Œæå–èµ„æº
                const resources = node.relations?.activity?.activity_resources || [];
                resources.forEach(resource => {
                    result.push({
                        name: node.node_name || 'æœªå‘½åè¯¾ç¨‹',
                        resource_id: resource.resource_id || '',
                        studyTime:resource.study_time
                    });
                });
            }
        };

        // éå†åˆå§‹èŠ‚ç‚¹æ•°ç»„
        fullDatas.nodes.forEach(node => traverse(node));
        return result.filter(item => item.resource_id); // è¿‡æ»¤æ— æ•ˆé¡¹

    }

    function getDynamicToken() {
        try {
            const pattern = /^ND_UC_AUTH-([0-9a-fA-F]{8}-([0-9a-fA-F]{4}-){3}[0-9a-fA-F]{12})&ncet-xedu&token$/;
            for (let key of Object.keys(localStorage)) {
                if (pattern.test(key)) {
                    return {
                        key: key,
                        appId: key.match(pattern)[1],
                        token: JSON.parse(JSON.parse(localStorage.getItem(key)).value)
                    };
                }
            }
            throw Error("Invalid token! can not get loginInfo!");
        } catch (err) {
            throw Error("At:getDynamicToken>>" + err);
        }
    }


    // const tokenData = getDynamicToken();
    // if (tokenData) {
    //     console.log("å®Œæ•´é”®å:", tokenData.key);
    //     console.log("ç”¨æˆ·UUID:", tokenData.uuid);
    //     console.log("Tokenå€¼:", tokenData.token);
    // }
    // ä½œè€…ï¼šzzzzzzys
    // https://greasyfork.org/zh-CN/users/1176747-zzzzzzys
    // æ¬è¿å¯è€»
    const getMACAuthorizationHeaders = function (url, method) {
        let n = getDynamicToken().token
        return He(url, method, {
            accessToken: n.access_token,
            macKey: n.mac_key,
            diff: n.diff
        });
    }

    function Ze(e) {
        for (var t = "0123456789ABCDEFGHIJKLMNOPQRTUVWXZYS".split(""), n = "", r = 0; r < e; r++)
            n += t[Math.ceil(35 * Math.random())];
        return n
    }

    function Fe(e) {
        return (new Date).getTime() + parseInt(e, 10) + ":" + Ze(8)
    }

    function ze(e, t, n, r) {
        let o = {
            relative: new URL(e).pathname,
            authority: new URL(e).hostname
        }
        let i = t + "\n" + n.toUpperCase() + "\n" + o.relative + "\n" + o.authority + "\n";
        return CryptoJS.HmacSHA256(i, r).toString(CryptoJS.enc.Base64)
    }

    function He(e) {
        // ä½œè€…ï¼šzzzzzzys
        // https://greasyfork.org/zh-CN/users/1176747-zzzzzzys
        // æ¬è¿å¯è€»
        let t = arguments.length > 1 && void 0 !== arguments[1] ? arguments[1] : "GET"
            , n = arguments.length > 2 ? arguments[2] : void 0
            , r = n.accessToken
            , o = n.macKey
            , i = n.diff
            , s = Fe(i)
            , a = ze(e, s, t, o);
        return 'MAC id="'.concat(r, '",nonce="').concat(s, '",mac="').concat(a, '"')
    }

    const setProgress = function (url, duration) {
        const info = getDynamicToken()
        return new Promise((resolve, reject) => {
            GM_xmlhttpRequest({
                'url': url,
                method: 'PUT',
                "headers": {
                    "accept": "application/json, text/plain, */*",
                    "accept-language": "zh-CN,zh;q=0.9,en;q=0.8,en-GB;q=0.7,en-US;q=0.6",
                    "authorization": getMACAuthorizationHeaders(url, 'PUT'),
                    "cache-control": "no-cache",
                    "pragma": "no-cache",
                    "content-type": "application/json",
                    "sdp-app-id": info.appId,
                    "sec-ch-ua": "\"Not A(Brand\";v=\"8\", \"Chromium\";v=\"132\", \"Microsoft Edge\";v=\"132\"",
                    "sec-ch-ua-mobile": "?0",
                    "sec-ch-ua-platform": "\"Windows\"",
                    "sec-fetch-dest": "empty",
                    "sec-fetch-mode": "cors",
                    "sec-fetch-site": "cross-site",
                    "host": "x-study-record-api.ykt.eduyun.cn",
                    "origin": "https://basic.smartedu.cn",
                    "referer": "https://basic.smartedu.cn/",
                    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36 Edg/121.0.0.0"
                },
                data: JSON.stringify({position: duration - 3}),
                // fetch:true,
                onload: function (res) {
                    console.log('è¯·æ±‚æˆåŠŸ')
                    console.log(res)
                    if (res.status === 200) {
                        console.log("åˆ·è¯¾æˆåŠŸï¼")
                        resolve(res)
                    }else {
                        reject('æœåŠ¡å™¨æ‹’ç»ï¼š'+res.response)
                    }
                },
                onerror: function (err) {
                    reject('è¯·æ±‚é”™è¯¯ï¼' + err.toString())
                }
            })
        })
    }

    function main () {
        init()
        if (!localStorage.getItem("noMoreDialog")) {
            showGuideDialog()
            // return
        }
        let myStyle = document.createElement('style')
        myStyle.innerHTML = style;
        document.head.appendChild(myStyle);
        /*let intercept=GM_GetValue*/
        let div = document.createElement('div');
        div.innerHTML = `<div style="left: 10px;top: 280px;" id="my1" class="button-3" >å³åˆ»å¼€åˆ·(ä¸­å°å­¦)</div>
                        <div style="position: fixed; left: 10px;top: 320px;;background: #ed5822;color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 3px 15px rgba(0,0,0,0.2);
            z-index: 999999999999;
            transition: transform 0.3s;" id="my3"    >èŒä¸šæ•™è‚²/é«˜ç­‰æ•™è‚² åˆ·è¯¾</div>
            <div style="left: 10px;top: 370px;" id="my2"   class="button-3" >2222</div>`
        document.body.appendChild(div);
        const trigger = document.getElementById('my3')
        trigger.addEventListener('click', () => {
            if (location.href.includes("core.teacher.vocational.smartedu.cn")) {
                createControlPanel()
            } else {
                Swal.fire({
                    title: "æ³¨æ„",
                    text: "è¯·åœ¨èŒä¸š/é«˜ç­‰æ•™è‚²çš„è§†é¢‘æ’­æ”¾é¡µé¢ä½¿ç”¨ï¼Œä¸­å°å­¦è¯·ç”¨ä¸Šé¢çš„æŒ‰é’®ï¼",
                    icon: 'info',
                    // showCancelButton: true,
                    confirmButtonColor: "#FF4DAFFF",
                    // cancelButtonText: "å–æ¶ˆï¼Œç­‰ä¼šåˆ·æ–°",
                    confirmButtonText: "äº†è§£~",

                }).then((result) => {

                });

            }
        });
        trigger.addEventListener('mouseenter', () => trigger.style.transform = 'scale(1.05)');
        trigger.addEventListener('mouseleave', () => trigger.style.transform = 'none');
        let isProcessing = false;
        const button = document.getElementById('my1');
        button.addEventListener("click", async () => {
            if (isProcessing) {
                Swal.fire({
                    title: "æ“ä½œè¿›è¡Œä¸­",
                    text: "æ­£åœ¨åˆ·è¯¾ä¸­ï¼Œè¯·å‹¿é‡å¤ç‚¹å‡»ï¼",
                    icon: "warning",
                    confirmButtonColor: "#FF4DAFFF",
                    confirmButtonText: "çŸ¥é“äº†"
                });
                return;
            }
            try {
                isProcessing = true; // æ ‡è®°å¼€å§‹å¤„ç†
                button.disabled = true; // ç¦ç”¨æŒ‰é’®
                button.textContent = "åˆ·è¯¾è¿›è¡Œä¸­..."; // ä¿®æ”¹æŒ‰é’®æ–‡å­—

                let resId
                const allResults = [];
                try {
                    // resId=getResourceId()
                }catch (e) {}
                if(!resId){
                    console.log("äºŒæ¬¡è·å–resId...")
                    resId=getResourceIdFromFullData()
                }
                if(resId && typeof resId === 'string') {
                    await setProgress(requestObj.resourceLearningPositions.url + resId + '/' + getDynamicToken().token["user_id"], getVideoTime())
                    allResults.push({ name: 'å•ä¸ªè¯¾ç¨‹',  status: 'success' });
                }else if (Array.isArray(resId) && resId.length > 0) {
                    const results = await Promise.allSettled(
                        resId.map(async (item) => {
                            try {
                                await setProgress(requestObj.resourceLearningPositions.url + item.resource_id + '/' + getDynamicToken().token["user_id"], item.studyTime)
                                return { name:item.name, status: 'success' };
                            } catch (e) {
                                console.error(`${item.name} å¤±è´¥ï¼`, e);
                                return { name:item.name, status: 'fail', error: e };
                            }
                        })
                    );
                    console.log(results)
                    results.forEach(r => {
                        if (r.status === 'fulfilled') allResults.push(r.value);
                        else allResults.push(r.reason); // æ•è·æœªå¤„ç†çš„æ„å¤–é”™è¯¯
                    });
                }

                if (Swal) {
                    Swal.fire({
                        title: "åˆ·è¯¾æˆåŠŸï¼",
                        html: `
            <div style="text-align: left; max-height: 60vh; overflow-y: auto;">
            <p>æ€»è®¡ï¼š${allResults.filter(r => r.status === 'success').length} æˆåŠŸ / ${allResults.filter(r => r.status === 'fail').length} å¤±è´¥</p>
            <hr>
            <ul style="padding-left: 20px; list-style-type: none;">
              ${allResults.map(result => `
                <li>
                  ${result.status === 'success' ? 'âœ…' : 'âŒ'}
                  <strong>${result.name}</strong> 
                  
                  ${result.error ? `<br><code style="color:red">${result.error.message || result.error}</code>` : ''}
                </li>
              `).join('')}
            </ul>
          </div>
            <div style="text-align: left;">
                <p>è§†é¢‘åªå‰©ä¸‹æœ€å5sï¼Œéœ€è¦çœ‹å®Œï¼Œè¯·åˆ·æ–°åå†è§‚çœ‹ï¼</p>
                <p>åˆ·è¯¾å‰è¯·å‹¿æ’­æ”¾è§†é¢‘ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´è¿›åº¦æ›´æ–°å¤±è´¥ï¼</p>
                <hr style="margin: 10px 0;">
                ${renderQQGroups()}
            </div>
        `,
                        icon: 'success',
                        confirmButtonColor: "#FF4DAFFF",
                        // cancelButtonText: "å–æ¶ˆï¼Œç­‰ä¼šåˆ·æ–°",
                        // ä½œè€…ï¼šzzzzzzys
                        // https://greasyfork.org/zh-CN/users/1176747-zzzzzzys
                        // æ¬è¿å¯è€»
                        confirmButtonText: "ç¡®å®š",

                    }).then((result) => {
                        if (result.isConfirmed) {
                        }
                    });
                }
            } catch (e) {
                console.error(e)
                if (Swal) {
                    Swal.fire({
                        title: "å¤±è´¥ï¼",
                        text: e.toString() + "    è¯·åœ¨è§†é¢‘æ’­æ”¾é¡µé¢ä½¿ç”¨ï¼",
                        icon: 'error',
                        // showCancelButton: true,
                        confirmButtonColor: "#FF4DAFFF",
                        // cancelButtonText: "å–æ¶ˆï¼Œç­‰ä¼šåˆ·æ–°",
                        confirmButtonText: "ç‚¹å‡»å»åé¦ˆ",

                    }).then((result) => {
                        if (result.isConfirmed) {
                            window.open("https://greasyfork.org/zh-CN/scripts/525037/feedback")
                        }
                    });
                }
            }finally {
            isProcessing = false; // é‡ç½®å¤„ç†çŠ¶æ€
            button.disabled = false; // æ¢å¤æŒ‰é’®
            button.textContent = "å³åˆ»å¼€åˆ·(ä¸­å°å­¦)"; // æ¢å¤æŒ‰é’®æ–‡å­—
        }


        })
        document.getElementById('my2').addEventListener('click', function () {
            Swal.fire({
                title: '<span style="font-size:24px; color: #FF4DAF;">æ¬¢è¿åŠ å…¥äº¤æµç¾¤</span>',
                html: `
        <div style="text-align: left; max-width: 580px; line-height: 1.7; font-size: 14px;">
            <!-- ç¤¾ç¾¤å…¥å£ -->
            ${renderQQGroups()}

            <!-- æ ¸å¿ƒä»·å€¼ -->
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                <!-- å·¦åˆ— -->
                <div style="padding-right:15px; border-right:1px dashed #eee;">
                    <div style="color: #27ae60; margin-bottom:15px;">
                        <h4 style="margin:0 0 8px 0; font-size:15px;">ğŸ“š å‡è´Ÿå·¥å…·</h4>
<!--                        <ul style="margin:0; padding-left:18px;">-->
<!--                            <li>è‡ªåŠ¨åŒ–å¤‡è¯¾å·¥å…·å¥—ä»¶</li>-->
<!--                            <li>æ™ºèƒ½å­¦æƒ…åˆ†ææŠ¥å‘Š</li>-->
<!--                            <li>æ•™å­¦èµ„æºæ™ºèƒ½æ£€ç´¢</li>-->
<!--                        </ul>-->
                    </div>

                    <div style="color: #2980b9; margin-top:15px;">
                        <h4 style="margin:0 0 8px 0; font-size:15px;">ğŸ›¡ï¸ ä½¿ç”¨è§„èŒƒ</h4>
                        <ul style="margin:0; padding-left:18px;">
                            <li>ä»…é™ä¸ªäººä½¿ç”¨</li>
                            <li>ç¦æ­¢å•†ä¸šå€’å–è¡Œä¸º</li>
                            <li>ç¦æ­¢åˆ©ç”¨æ­¤è„šæœ¬æ”¶è´¹ä»£åˆ·</li>
                            <li>è¯·å‹¿æ‰¹é‡è‡ªåŠ¨åŒ–æ“ä½œå¤§é‡åˆ·è¯¾ï¼ˆå¦‚éœ€è¦è¯·è”ç³»æˆ‘ï¼Œæ›´åŠ é«˜æ•ˆå®‰å…¨ï¼‰</li>
                        </ul>
                    </div>
                </div>

                <!-- å³åˆ— -->
                <div style="padding-left:15px;">
                    <div style="color: #e67e22;">
                        <h4 style="margin:0 0 8px 0; font-size:15px;">âš–ï¸ ç‰ˆæƒå£°æ˜</h4>
                        <ul style="margin:0; padding-left:18px;">
                            <li>æœ¬å·¥å…·å®Œå…¨å…è´¹</li>
                            <li>æºç ç¦æ­¢äºŒæ¬¡ä¼ æ’­</li>
<!--                            <li>ä¿ç•™åŸåˆ›æ³•å¾‹æƒåˆ©</li>-->
                        </ul>
                    </div>

                    <div style="color: #9b59b6; margin-top:15px;">
                        <h4 style="margin:0 0 8px 0; font-size:15px;">ğŸ’Œ è”ç³»æˆ‘ä»¬</h4>
                        <ul style="margin:0; padding-left:18px;">
<!--                            <li>åé¦ˆå»ºè®®ï¼šedu@service.com</li>-->
                            <li>ç´§æ€¥é—®é¢˜ï¼šè¯·ç§èŠç¾¤ç®¡ç†å‘˜</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    `,
                icon: 'info',
                confirmButtonColor: "#FF4DAF",
                confirmButtonText: "2222",
                showCloseButton: true,
                width: 680,
                showDenyButton: true,
                denyButtonText: '<img src="https://img.icons8.com/fluency/24/star--v1.png" style="height:18px; vertical-align:middle;"> å‰å¾€å¥½è¯„', // å¸¦å›¾æ ‡çš„æŒ‰é’®
                denyButtonColor: '#FFC107',
                focusDeny: false,
                showCancelButton: false,

                // æ–°å¢æŒ‰é’®å›è°ƒ
                preDeny: () => {
                    window.open("https://greasyfork.org/zh-CN/scripts/525037/feedback", "_blank");
                    return false; // é˜»æ­¢å¼¹çª—å…³é—­
                },

                customClass: {
                    denyButton: 'swal-custom-deny',
                    popup: 'swal-custom-popup',
                    title: 'swal-custom-title'
                },
                footer: '<div style="color:#95a5a6; font-size:12px;">è¯·åˆç†ä½¿ç”¨ã€‚</div>'
            });
        });
    }
    main()
})();
